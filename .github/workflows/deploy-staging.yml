name: Deploy to Staging

on:
  push:
    branches:
      - stage
  pull_request:
    branches:
      - stage

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_STAGING }}
      SUPABASE_PROJECT_ID: wuinfsedukvxlkfvlpna
      VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL_STAGE }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      

      - name: Run Supabase migrations
        run: |
          echo "ðŸ”„ Linking to Supabase project: $SUPABASE_PROJECT_ID"
          supabase link --project-ref $SUPABASE_PROJECT_ID
          echo "ðŸ“¦ Applying database migrations..."
          supabase db push
          echo "âœ… Migrations applied successfully"
      
      - name: Deploy Supabase Edge Functions
        if: success()
        run: |
          echo "âš¡ Deploying Edge Functions to Supabase project: $SUPABASE_PROJECT_ID"
          supabase functions deploy --project-ref $SUPABASE_PROJECT_ID
          echo "âœ… Edge Functions deployed successfully"
      
      - name: Trigger Vercel Deploy
        if: success()
        run: |
          if [ -z "$VERCEL_DEPLOY_HOOK_URL" ]; then
            echo "::error::Missing VERCEL_DEPLOY_HOOK_URL_STAGE secret"
            exit 1
          fi
          echo "ðŸš€ Triggering Vercel deployment..."
          curl -X POST "$VERCEL_DEPLOY_HOOK_URL"
          echo "âœ… Vercel deployment triggered successfully"
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Database Migrations | âœ… Applied | Project: \`$SUPABASE_PROJECT_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Edge Functions | âœ… Deployed | Project: \`$SUPABASE_PROJECT_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Vercel Preview | âœ… Triggered | Deployment in progress |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Vercel deployment was triggered via Deploy Hook. Check [Vercel Dashboard](https://vercel.com/dashboard) for deployment status." >> $GITHUB_STEP_SUMMARY
          
          echo "âœ… Staging Deployment Complete"
          echo "ðŸ“¦ Migrations applied to Supabase project: $SUPABASE_PROJECT_ID"
          echo "âš¡ Edge Functions deployed"
          echo "ðŸš€ Vercel deployment triggered"
